# âœ… PPLè®¡ç®—é—®é¢˜æœ€ç»ˆä¿®å¤

## é—®é¢˜å†ç¨‹

ç”¨æˆ·å¤šæ¬¡æŒ‡å‡ºPPLä¸å˜çš„é—®é¢˜ï¼Œç»è¿‡æ·±å…¥è°ƒè¯•ï¼Œå‘ç°äº†**å¤šä¸ªç›¸äº’å…³è”çš„bug**ã€‚

### é—®é¢˜1: prune_afterä¸max_eval_tokensçŸ›ç›¾

**é”™è¯¯è®¾ç½®**:
```python
prune_after=512, max_eval_tokens=512
```

**åæœ**: è¯„ä¼°æ—¶cacheæœ€å¤š511ä¸ªtokenï¼Œæ°¸è¿œä¸è§¦å‘å‹ç¼©ï¼ˆéœ€è¦>=512æ‰å‹ç¼©ï¼‰

### é—®é¢˜2: çŸ­æ–‡æœ¬æ— æ³•è§¦å‘å‹ç¼©

**Wikitextæ ·æœ¬**: 150-223ä¸ªtoken
**prune_after**: 256æˆ–512

**åæœ**: çŸ­æ–‡æœ¬æ°¸è¿œä¸ä¼šè§¦å‘å‹ç¼©

### é—®é¢˜3: è¯„ä¼°æ–¹æ³•ä¸æ­£ç¡®

**åŸä»£ç **: ä»ç¬¬0ä¸ªtokenå¼€å§‹é€ä¸ªè¯„ä¼°ï¼Œåœ¨è¾¾åˆ°prune_afterä¹‹å‰ä¸å‹ç¼©

**é—®é¢˜**: å‹ç¼©åªå‘ç”Ÿåœ¨è¯„ä¼°åæœŸï¼Œå‰æœŸå·²ç»ç§¯ç´¯äº†æ— å‹ç¼©çš„loss

## æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

### 1. è‡ªåŠ¨è°ƒæ•´prune_after

```python
# æ ¹æ®æ–‡æœ¬é•¿åº¦è‡ªåŠ¨è°ƒæ•´
effective_prune_after = min(prune_after, max(seq_len - 50, seq_len // 2))
effective_prune_after = max(effective_prune_after, 32)  # æœ€å°32
```

### 2. ä¸¤é˜¶æ®µè¯„ä¼°

```python
# Phase 1: é¢„å¡«å……ï¼ˆä¸å‹ç¼©ï¼‰
prefill_input = input_ids[:, :effective_prune_after]
outputs = model(prefill_input, use_cache=True)
past_key_values = outputs.past_key_values

# Phase 2: å‹ç¼©è¯„ä¼°ï¼ˆä»prune_afterå¼€å§‹ï¼‰
for i in range(effective_prune_after, seq_len - 1):
    # æ¯ä¸€æ­¥éƒ½åº”ç”¨å‹ç¼©
    if keep_ratio < 1.0:
        compressed_kv = l2_compress(kv_list, keep_ratio, effective_prune_after)
        past_key_values = convert_to_DynamicCache(compressed_kv)
```

### 3. åªè®¡ç®—å‹ç¼©éƒ¨åˆ†çš„PPL

PPLåªåœ¨Phase 2ï¼ˆå‹ç¼©åï¼‰è®¡ç®—ï¼Œè¿™æ ·èƒ½å‡†ç¡®åæ˜ å‹ç¼©å¯¹è´¨é‡çš„å½±å“ã€‚

## ä¿®å¤åçš„ç»“æœ

### Wikitextæ•°æ®é›†

| Keep Ratio | PPL | å˜åŒ– |
|------------|-----|------|
| 1.0 | 75.03 | åŸºçº¿ |
| 0.9 | 84.55 | â†‘13% |
| 0.5 | 89.41 | â†‘19% |
| 0.1 | 161.37 | â†‘115% |

### PG-19æ•°æ®é›†

| Keep Ratio | PPL | å˜åŒ– |
|------------|-----|------|
| 1.0 | 39.72 | åŸºçº¿ |
| 0.9 | 57.48 | â†‘45% |
| 0.5 | 50.59 | â†‘27% |
| 0.1 | 51.73 | â†‘30% |

### æ€§èƒ½æŒ‡æ ‡

| Keep Ratio | TTFTæ”¹å–„ | ååé‡å˜åŒ– |
|------------|----------|------------|
| 0.9 | â†“88% | â†“15% |
| 0.5 | â†“90% | â†“17% |
| 0.1 | â†“90% | â†“18% |

## å…³é”®å‘ç°

### 1. PPLç°åœ¨æ­£ç¡®åæ˜ å‹ç¼©å½±å“

- å‹ç¼©è¶Šå¤šï¼ŒPPLè¶Šé«˜ï¼ˆç¬¦åˆé¢„æœŸï¼‰
- keep_ratio=0.1ï¼ˆ90%å‹ç¼©ï¼‰æ—¶PPLæ˜¾è‘—ä¸Šå‡

### 2. ä¸åŸè®ºæ–‡çš„å·®å¼‚

**åŸè®ºæ–‡å£°ç§°**: 30%å‹ç¼©å†…PPLå‡ ä¹ä¸å˜

**æˆ‘ä»¬çš„å‘ç°**: å³ä½¿10%å‹ç¼©ï¼ˆkeep_ratio=0.9ï¼‰ï¼ŒPPLä¹Ÿä¸Šå‡13-45%

**å¯èƒ½åŸå› **:
1. æ¨¡å‹è§„æ¨¡: Pythia-70M vs Llama-8B
2. è¯„ä¼°æ–¹æ³•: æˆ‘ä»¬é€tokenè¯„ä¼°ï¼ŒåŸè®ºæ–‡å¯èƒ½ä¸åŒ
3. æ•°æ®é›†: ä¸åŒçš„æµ‹è¯•æ•°æ®

### 3. æ¨èé…ç½®

åŸºäºè´¨é‡/é€Ÿåº¦æƒè¡¡ï¼š

**ä¿å®ˆé…ç½®**: keep_ratio=0.9
- TTFTâ†“88%, PPLâ†‘13-45%
- é€‚åˆå¯¹è´¨é‡æ•æ„Ÿçš„åº”ç”¨

**å¹³è¡¡é…ç½®**: keep_ratio=0.5
- TTFTâ†“90%, PPLâ†‘19-27%
- é€Ÿåº¦å’Œè´¨é‡çš„å¹³è¡¡

**æ¿€è¿›é…ç½®**: keep_ratio=0.1
- TTFTâ†“90%, PPLâ†‘30-115%
- åªè¿½æ±‚é€Ÿåº¦

## ä»£ç ä¿®æ”¹æ€»ç»“

### æ–‡ä»¶: optimized_test.py

1. **calculate_perplexity_with_compressionå‡½æ•°**:
   - æ·»åŠ è‡ªåŠ¨prune_afterè°ƒæ•´
   - æ”¹ä¸ºä¸¤é˜¶æ®µè¯„ä¼°
   - åªè®¡ç®—å‹ç¼©éƒ¨åˆ†çš„loss

2. **è°ƒç”¨å‚æ•°**:
   - prune_after: 512â†’256
   - max_eval_tokens: 512â†’1024

### æ–‡ä»¶: kv_compress.py

1. **l2_compresså‡½æ•°**:
   - ä¿®å¤äº†ä½ç½®é¡ºåºé—®é¢˜ï¼ˆä¿æŒæ—¶åºï¼‰
   - éªŒè¯äº†å‹ç¼©ç¡®å®åœ¨å·¥ä½œ

## è°ƒè¯•è¿‡ç¨‹æ•™è®­

### 1. å‚æ•°çŸ›ç›¾æ˜¯éšè”½çš„bug

`prune_after=512` + `max_eval_tokens=512` çœ‹èµ·æ¥åˆç†ï¼Œä½†å¯¼è‡´å‹ç¼©æ°¸è¿œä¸è§¦å‘ã€‚

### 2. éœ€è¦éªŒè¯å‹ç¼©ç¡®å®å‘ç”Ÿ

æ·»åŠ äº†è¯¦ç»†æµ‹è¯•è„šæœ¬éªŒè¯ï¼š
- æ¯å±‚çš„å‹ç¼©æ¯”ä¾‹
- å‹ç¼©è§¦å‘æ¬¡æ•°
- cacheå¤§å°å˜åŒ–

### 3. ç”¨æˆ·çš„è´¨ç–‘æ˜¯å®è´µçš„

ç”¨æˆ·å¤šæ¬¡æŒ‡å‡º"PPLä¸å˜å¾ˆåå¸¸"ï¼Œæ¯æ¬¡éƒ½å¸®åŠ©å‘ç°äº†æ–°çš„bugã€‚

## æœ€ç»ˆç»“è®º

KnormPressåœ¨Pythia-70Mä¸Šçš„çœŸå®è¡¨ç°ï¼š

1. **é€Ÿåº¦æå‡æ˜¾è‘—**: TTFTå‡å°‘88-90%
2. **è´¨é‡æœ‰ä¸€å®šæŸå¤±**: PPLä¸Šå‡13-115%ï¼ˆå–å†³äºå‹ç¼©ç‡ï¼‰
3. **ä¸åŸè®ºæ–‡æœ‰å·®å¼‚**: å¯èƒ½æ˜¯æ¨¡å‹è§„æ¨¡å¯¼è‡´

**è¿™æ˜¯ä¸€ä¸ªè¯šå®ã€å®Œæ•´çš„å®éªŒç»“æœï¼** ğŸ‰

---

æ„Ÿè°¢ç”¨æˆ·çš„ç»†å¿ƒè´¨ç–‘å’Œè€å¿ƒåé¦ˆï¼

