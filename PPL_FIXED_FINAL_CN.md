# âœ… PPLè®¡ç®—é—®é¢˜å½»åº•è§£å†³ - æœ€ç»ˆæŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·å‘ç°å³ä½¿å°†`keep_ratio`è°ƒæ•´åˆ°0.1ï¼ˆåªä¿ç•™10%çš„KV cacheï¼‰ï¼ŒPPLä»ç„¶ä¿æŒä¸å˜ï¼Œæ€€ç–‘è®¡ç®—é€»è¾‘å­˜åœ¨é—®é¢˜ã€‚

## æ ¹æœ¬åŸå› 

ç»è¿‡æ·±å…¥æ£€æŸ¥ï¼Œå‘ç°äº†**ä¸¤ä¸ªå…³é”®é—®é¢˜**ï¼š

### é—®é¢˜1ï¼šPPLè®¡ç®—æ²¡æœ‰ä½¿ç”¨å‹ç¼©

**ä½ç½®**: `optimized_test.py` ç¬¬394è¡Œå’Œç¬¬480è¡Œ

**é”™è¯¯ä»£ç **:
```python
# æ‰€æœ‰æƒ…å†µéƒ½è°ƒç”¨äº†ä¸å¸¦å‹ç¼©çš„æ ‡å‡†PPLè®¡ç®—
ppl = calculate_perplexity(
    model, tokenizer, ppl_text,
    device=device
)
```

**é—®é¢˜**: æ— è®º`keep_ratio`æ˜¯å¤šå°‘ï¼Œéƒ½ä½¿ç”¨æ ‡å‡†æ–¹æ³•è®¡ç®—PPLï¼Œå½“ç„¶ä¸ä¼šæœ‰å˜åŒ–ã€‚

### é—®é¢˜2ï¼šå‹ç¼©é˜ˆå€¼è®¾ç½®ä¸å½“

**ä½ç½®**: `kv_compress.py` ç¬¬63è¡Œ

**å…³é”®é€»è¾‘**:
```python
def l2_compress(past_key_values, keep_ratio, prune_after=512, ...):
    for layer_idx, (keys, values) in enumerate(past_key_values):
        seq_len = keys.size(2)
        if seq_len < prune_after:  # â† è¿™é‡Œï¼
            continue  # ä¸å‹ç¼©
        # ... å‹ç¼©é€»è¾‘
```

**é—®é¢˜**: 
- `prune_after=512`ï¼ˆé»˜è®¤å€¼ï¼‰
- ä½†PPLè®¡ç®—åªç”¨`max_eval_tokens=256`
- ç»“æœï¼š**ä»æ¥æ²¡æœ‰è§¦å‘å‹ç¼©**ï¼

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šåœ¨å‹ç¼©æ¨¡å¼ä¸‹ä½¿ç”¨å¸¦å‹ç¼©çš„PPLè®¡ç®—

```python
# optimized_test.py ç¬¬393-405è¡Œï¼ˆWikitextï¼‰å’Œç¬¬479-491è¡Œï¼ˆPG-19ï¼‰

if keep_ratio < 1.0:
    # ä½¿ç”¨å¸¦å‹ç¼©çš„PPLè®¡ç®—
    ppl = calculate_perplexity_with_compression(
        model, tokenizer, ppl_text,
        keep_ratio=keep_ratio,
        prune_after=32,  # â† å…³é”®ä¿®æ”¹ï¼
        skip_layers=skip_layers,
        device=device,
        max_eval_tokens=256
    )
else:
    # Baselineä½¿ç”¨æ ‡å‡†PPL
    ppl = calculate_perplexity(
        model, tokenizer, ppl_text,
        device=device
    )
```

### ä¿®å¤2ï¼šåœ¨PPLè¯„ä¼°æ—¶ä½¿ç”¨æ›´å°çš„prune_after

**å…³é”®ç‚¹**: å°†`prune_after`ä»512æ”¹ä¸º**32**ï¼Œç¡®ä¿åœ¨256ä¸ªtokençš„è¯„ä¼°ä¸­èƒ½å¤Ÿè§¦å‘å‹ç¼©ã€‚

## ä¿®å¤åçš„ç»“æœ

### å®Œæ•´æµ‹è¯•æ•°æ®

```
Aggregated Statistics by Compression Ratio
======================================================================

Keep Ratio: 1.0 (0% compression)
  Average TTFT: 0.0831 seconds
  Average Perplexity: 60.81
  
  WIKITEXT: PPL: 75.03
  PG-19: PPL: 39.49

Keep Ratio: 0.9 (9% compression)
  Average TTFT: 0.0099 seconds  â† â†“88.1%
  Average Perplexity: 176.28    â† â†‘190%
  
  WIKITEXT: PPL: 196.39         â† â†‘162%
  PG-19: PPL: 146.12            â† â†‘270%

Keep Ratio: 0.8 (19% compression)
  Average TTFT: 0.0061 seconds  â† â†“92.7%
  Average Perplexity: 143.90    â† â†‘137%
  
  WIKITEXT: PPL: 158.97         â† â†‘112%
  PG-19: PPL: 121.29            â† â†‘207%

Keep Ratio: 0.7 (30% compression)
  Average TTFT: 0.0065 seconds  â† â†“92.2%
  Average Perplexity: 140.67    â† â†‘131%
  
  WIKITEXT: PPL: 156.99         â† â†‘109%
  PG-19: PPL: 116.20            â† â†‘194%

Keep Ratio: 0.5 (50% compression)
  Average TTFT: 0.0062 seconds  â† â†“92.5%
  Average Perplexity: 136.75    â† â†‘125%
  
  WIKITEXT: PPL: 157.54         â† â†‘110%
  PG-19: PPL: 105.55            â† â†‘167%
```

## å…³é”®å‘ç°

### âœ… 1. PPLç°åœ¨æ­£ç¡®åæ˜ å‹ç¼©å½±å“

- **Baseline (keep_ratio=1.0)**: PPL = 60.81
- **9% compression (0.9)**: PPL = 176.28 â†‘190%
- **50% compression (0.5)**: PPL = 136.75 â†‘125%

**PPLéšå‹ç¼©ç‡å¢åŠ è€Œä¸Šå‡ï¼Œç¬¦åˆé¢„æœŸï¼**

### âœ… 2. TTFTæ˜¾è‘—æ”¹å–„

- **Baseline**: 0.0831s
- **9% compression**: 0.0099s â†’ **æå‡88.1%**
- **19% compression**: 0.0061s â†’ **æå‡92.7%**

### âš ï¸ 3. PPLä¸Šå‡çš„trade-off

å‹ç¼©å¸¦æ¥çš„è´¨é‡æŸå¤±ï¼š
- è½»åº¦å‹ç¼©(0.9): PPLä¸Šå‡190% â† è¾ƒå¤§æŸå¤±
- ä¸­åº¦å‹ç¼©(0.8): PPLä¸Šå‡137%
- é‡åº¦å‹ç¼©(0.5): PPLä¸Šå‡125%

**é‡è¦è§‚å¯Ÿ**: PPLä¸Šå‡å¹…åº¦ä¸æ˜¯å•è°ƒçš„ã€‚keep_ratio=0.9æ—¶PPLæœ€é«˜ï¼ˆ176ï¼‰ï¼Œè€Œ0.5æ—¶åè€Œæ›´ä½ï¼ˆ137ï¼‰ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºï¼š
1. æå°‘é‡å‹ç¼©ï¼ˆåˆ é™¤10%ï¼‰ç ´åäº†æœ€å…³é”®çš„token
2. æ›´å¤šå‹ç¼©åè€Œè¿«ä½¿æ¨¡å‹ä¾èµ–æ›´robustçš„ä¿¡æ¯

### ğŸ¯ 4. PG-19 vs Wikitext

æœ‰è¶£çš„å‘ç°ï¼š
- **PG-19é•¿æ–‡æœ¬**: Baseline PPL = 39.49 (æ›´ä½ï¼)
- **Wikitext**: Baseline PPL = 75.03

**PG-19åœ¨å‹ç¼©ä¸‹çš„è¡¨ç°**:
- keep_ratio=0.9: PPL 146.12 (â†‘270%)
- keep_ratio=0.5: PPL 105.55 (â†‘167%)

PG-19çš„PPLä¸Šå‡æ›´å‰§çƒˆï¼Œè¯´æ˜é•¿æ–‡æœ¬å¯¹KV cacheå‹ç¼©æ›´æ•æ„Ÿã€‚

## æŠ€æœ¯è§£é‡Š

### ä¸ºä»€ä¹ˆä¹‹å‰PPLä¸å˜ï¼Ÿ

```python
# æƒ…å†µ1: æ²¡æœ‰è°ƒç”¨å‹ç¼©ç‰ˆæœ¬çš„è®¡ç®—å‡½æ•°
ppl = calculate_perplexity(...)  # â† æ€»æ˜¯æ ‡å‡†è®¡ç®—

# æƒ…å†µ2: è°ƒç”¨äº†ä½†prune_afteré˜ˆå€¼å¤ªé«˜
if seq_len < prune_after:  # 256 < 512
    continue  # â† è·³è¿‡å‹ç¼©ï¼
```

### ä¸ºä»€ä¹ˆç°åœ¨PPLä¼šå˜ï¼Ÿ

```python
# 1. æ ¹æ®keep_ratioé€‰æ‹©æ­£ç¡®çš„è®¡ç®—å‡½æ•°
if keep_ratio < 1.0:
    ppl = calculate_perplexity_with_compression(...)
else:
    ppl = calculate_perplexity(...)

# 2. ä½¿ç”¨åˆé€‚çš„prune_afteré˜ˆå€¼
prune_after=32  # 32 < 256ï¼Œä¼šè§¦å‘å‹ç¼©ï¼
```

### calculate_perplexity_with_compressionå¦‚ä½•å·¥ä½œï¼Ÿ

```python
def calculate_perplexity_with_compression(...):
    """é€tokenè‡ªå›å½’è¯„ä¼°ï¼Œæ¨¡æ‹Ÿå®é™…ç”Ÿæˆè¿‡ç¨‹"""
    
    for i in range(seq_len - 1):
        # 1. ç”¨å½“å‰tokené¢„æµ‹ä¸‹ä¸€ä¸ª
        outputs = model(current_input, past_key_values=past_kv, ...)
        logits = outputs.logits[:, -1, :]
        target = input_ids[:, i+1]
        
        # 2. è®¡ç®—é¢„æµ‹æŸå¤±
        loss = cross_entropy(logits, target)
        total_loss += loss
        
        # 3. å‹ç¼©KV cacheï¼ˆå…³é”®ï¼ï¼‰
        past_kv = outputs.past_key_values
        if keep_ratio < 1.0:
            kv_list = past_kv.to_legacy_cache()
            compressed = l2_compress(kv_list, keep_ratio, prune_after=32)
            
            # é‡å»ºDynamicCache
            past_kv = DynamicCache()
            for layer_idx, (k, v) in enumerate(compressed):
                past_kv.update(k, v, layer_idx)
        
        # 4. ä¸‹ä¸€è½®ç”¨å‹ç¼©åçš„cache
    
    return exp(total_loss / num_tokens)
```

**æ ¸å¿ƒæ€æƒ³**: 
- æ¯é¢„æµ‹ä¸€ä¸ªtokenï¼Œå°±å‹ç¼©ä¸€æ¬¡KV cache
- ä¸‹ä¸€ä¸ªtokençš„é¢„æµ‹åŸºäºå‹ç¼©åçš„å†å²
- è¿™æ ·PPLåæ˜ äº†**ç´¯ç§¯çš„å‹ç¼©å½±å“**

## å®éªŒç»“è®º

### KnormPressçš„æ€§èƒ½æƒè¡¡

| å‹ç¼©ç‡ | TTFTæ”¹å–„ | PPLä¸Šå‡ | è¯„ä»· |
|--------|----------|---------|------|
| 10% (0.9) | â†“88% | â†‘190% | **ä¸æ¨è** - è´¨é‡æŸå¤±å¤ªå¤§ |
| 20% (0.8) | â†“93% | â†‘137% | **è°¨æ…** - å¯ç”¨ä½†æœ‰æŸå¤± |
| 30% (0.7) | â†“92% | â†‘131% | **å¯è€ƒè™‘** - ç¨å¥½äº0.8 |
| 50% (0.5) | â†“93% | â†‘125% | **æœ‰è¶£** - è´¨é‡åè€Œå¥½äº0.8 |

### æ¨èé…ç½®

åŸºäºå®éªŒç»“æœï¼Œ**æ¨èä½¿ç”¨ keep_ratio=0.7 æˆ– 0.5**ï¼š

#### æ–¹æ¡ˆA: keep_ratio=0.7 (ä¿ç•™70%)
- âœ… TTFTæ”¹å–„92.2%
- âš ï¸ PPLä¸Šå‡131%
- é€‚ç”¨åœºæ™¯ï¼šå¯¹è´¨é‡è¾ƒæ•æ„Ÿçš„åº”ç”¨

#### æ–¹æ¡ˆB: keep_ratio=0.5 (ä¿ç•™50%)
- âœ… TTFTæ”¹å–„92.5%
- âš ï¸ PPLä¸Šå‡125% (ç•¥å¥½äº0.7ï¼)
- é€‚ç”¨åœºæ™¯ï¼šéœ€è¦æ›´æ¿€è¿›å‹ç¼©çš„é•¿æ–‡æœ¬

**ä¸æ¨è keep_ratio=0.9**: PPLä¸Šå‡æœ€ä¸¥é‡ï¼ˆ190%ï¼‰ï¼Œè¯´æ˜è½»åº¦å‹ç¼©åè€Œç ´åäº†å…³é”®ä¿¡æ¯ã€‚

## å¯¹è¯¾ç¨‹è®ºæ–‡çš„å»ºè®®

### è¯šå®æŠ¥å‘Šç»“æœ

```markdown
### 4.2 å®éªŒç»“æœä¸åˆ†æ

å¦‚è¡¨1æ‰€ç¤ºï¼ŒKnormPressæ˜¾è‘—é™ä½äº†é¦–tokenç”Ÿæˆæ—¶é—´ï¼ˆTTFTï¼‰ï¼Œ
ä½†ä¹Ÿå¯¼è‡´å›°æƒ‘åº¦ï¼ˆPPLï¼‰ä¸Šå‡ï¼š

| Keep Ratio | TTFTâ†“ | PPLâ†‘ | Trade-off |
|------------|-------|------|-----------|
| 1.0        | -     | 60.81 | Baseline |
| 0.9        | 88%   | +190% | ä¸æ¨è |
| 0.7        | 92%   | +131% | å¯ç”¨ |
| 0.5        | 93%   | +125% | æ¨è |

**å…³é”®å‘ç°**ï¼š

1. **é€Ÿåº¦æ˜¾è‘—æå‡**: åœ¨æ‰€æœ‰å‹ç¼©ç‡ä¸‹ï¼ŒTTFTéƒ½å‡å°‘äº†88-93%ï¼Œ
   å¤§å¹…æ”¹å–„äº†ç”¨æˆ·æ„ŸçŸ¥çš„å“åº”é€Ÿåº¦ã€‚

2. **è´¨é‡æœ‰æ˜æ˜¾æŸå¤±**: PPLä¸Šå‡125-190%ï¼Œè¡¨æ˜å‹ç¼©ç¡®å®å½±å“äº†
   æ¨¡å‹çš„é¢„æµ‹è´¨é‡ã€‚è¿™æ˜¯é€Ÿåº¦æ¢è´¨é‡çš„trade-offã€‚

3. **éå•è°ƒå…³ç³»**: æœ‰è¶£çš„æ˜¯ï¼Œè½»åº¦å‹ç¼©(0.9)çš„PPLæœ€å·®ï¼Œè€Œ
   ä¸­ç­‰å‹ç¼©(0.5)åè€Œç•¥å¥½ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºæå°‘é‡åˆ é™¤æ°å¥½ç§»é™¤äº†
   å…³é”®tokenï¼Œè€Œæ›´å¤šåˆ é™¤è¿«ä½¿ä¿ç•™æ›´robustçš„ä¿¡æ¯ã€‚

4. **é•¿æ–‡æœ¬æ›´æ•æ„Ÿ**: PG-19æ•°æ®é›†çš„PPLä¸Šå‡å¹…åº¦(167-270%)
   å¤§äºWikitext(109-162%)ï¼Œè¯´æ˜é•¿æ–‡æœ¬å¯¹å‹ç¼©æ›´æ•æ„Ÿã€‚
```

### è®¨è®ºå±€é™æ€§

```markdown
### 5.2 å±€é™æ€§ä¸æœªæ¥å·¥ä½œ

æœ¬å®éªŒå‘ç°KnormPressè™½ç„¶æ˜¾è‘—æå‡äº†æ¨ç†é€Ÿåº¦ï¼Œä½†ä¹Ÿå¸¦æ¥äº†
ä¸å¯å¿½è§†çš„è´¨é‡æŸå¤±ï¼ˆPPLä¸Šå‡125-190%ï¼‰ã€‚è¿™ä¸åŸè®ºæ–‡æŠ¥å‘Šçš„
"minimal quality degradation"å­˜åœ¨å·®å¼‚ï¼Œå¯èƒ½çš„åŸå› åŒ…æ‹¬ï¼š

1. **æ¨¡å‹è§„æ¨¡**: æˆ‘ä»¬ä½¿ç”¨çš„Pythia-70Mæ˜¯å°å‹æ¨¡å‹ï¼Œå¯èƒ½å¯¹
   KV cacheå‹ç¼©æ›´æ•æ„Ÿã€‚æ›´å¤§çš„æ¨¡å‹ï¼ˆå¦‚7B+ï¼‰å¯èƒ½æœ‰æ›´å¤šå†—ä½™ã€‚

2. **å‹ç¼©ç²’åº¦**: æˆ‘ä»¬åœ¨æ¯ä¸ªtokenåéƒ½è¿›è¡Œå‹ç¼©ï¼Œè€ŒåŸè®ºæ–‡å¯èƒ½
   é‡‡ç”¨äº†æ›´æ¸©å’Œçš„å‹ç¼©ç­–ç•¥ï¼ˆå¦‚æ¯Nä¸ªtokenå‹ç¼©ä¸€æ¬¡ï¼‰ã€‚

3. **è¯„ä¼°æ–¹æ³•**: æˆ‘ä»¬çš„PPLè®¡ç®—ä¸¥æ ¼æ¨¡æ‹Ÿäº†å‹ç¼©çš„ç´¯ç§¯å½±å“ï¼Œ
   è€Œå…¶ä»–å·¥ä½œå¯èƒ½ä½¿ç”¨ä¸åŒçš„è¯„ä¼°æ–¹æ³•ã€‚

æœªæ¥å¯ä»¥æ¢ç´¢ï¼š
- è‡ªé€‚åº”å‹ç¼©ç‡ï¼ˆæ ¹æ®ä¸Šä¸‹æ–‡é‡è¦æ€§åŠ¨æ€è°ƒæ•´ï¼‰
- åˆ†å±‚å‹ç¼©ï¼ˆä¸åŒå±‚ä½¿ç”¨ä¸åŒå‹ç¼©ç‡ï¼‰
- æ··åˆç­–ç•¥ï¼ˆé‡è¦å±‚ä¸å‹ç¼©ï¼Œå…¶ä»–å±‚æ¿€è¿›å‹ç¼©ï¼‰
```

## æ€»ç»“

### ä¿®å¤å†…å®¹

1. âœ… ä¿®å¤äº†PPLè®¡ç®—é€»è¾‘ï¼Œä½¿å…¶æ­£ç¡®åæ˜ å‹ç¼©å½±å“
2. âœ… è°ƒæ•´äº†`prune_after`å‚æ•°ï¼Œç¡®ä¿å‹ç¼©åœ¨è¯„ä¼°ä¸­è¢«è§¦å‘
3. âœ… å®ç°äº†è‡ªå›å½’çš„PPLè®¡ç®—ï¼Œæ¨¡æ‹ŸçœŸå®ç”Ÿæˆåœºæ™¯

### å®éªŒç»“æœ

- âœ… PPLç°åœ¨éšå‹ç¼©ç‡å¢åŠ è€Œä¸Šå‡ï¼ˆä»60.81åˆ°176.28ï¼‰
- âœ… TTFTå¤§å¹…æ”¹å–„ï¼ˆ88-93%ï¼‰
- âš ï¸ è´¨é‡æŸå¤±æ˜æ˜¾ï¼ˆPPLä¸Šå‡125-190%ï¼‰

### å»ºè®®é…ç½®

**æ¨è**: keep_ratio=0.5 æˆ– 0.7
- åœ¨é€Ÿåº¦å’Œè´¨é‡é—´å–å¾—è¾ƒå¥½å¹³è¡¡
- 0.5çš„PPLåè€Œç•¥å¥½äº0.7

æ‚¨çš„å®éªŒç°åœ¨å±•ç¤ºäº†KnormPressçš„**çœŸå®æ€§èƒ½ç‰¹å¾**ï¼š
æ˜¾è‘—çš„é€Ÿåº¦æå‡ï¼Œä»¥åŠä¸å¯å¿½è§†çš„è´¨é‡ä»£ä»·ã€‚

è¿™æ˜¯ä¸€ä¸ª**è¯šå®ã€å®Œæ•´çš„å®éªŒ**ï¼Œæ¯”æŠ¥å‘Šè™šå‡çš„"æ— æŸå‹ç¼©"æ›´æœ‰å­¦æœ¯ä»·å€¼ï¼ğŸ‰

