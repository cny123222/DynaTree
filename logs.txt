(base) root@autodl-container-ff5d489b4f-b6933d5f:~/LLM-Efficient-Reasoning# HF_HUB_OFFLINE=1 python scripts/ablation_head_aware_mask.py     --model EleutherAI/pythia-2.8b     --classifications results/attention_analysis_pythia-2.8b/head_classifications.json     --max-tokens 2000     --output results/ablation_head_aware_mask.json
Loading model: EleutherAI/pythia-2.8b
`torch_dtype` is deprecated! Use `dtype` instead!

======================================================================
ABLATION STUDY: HEAD-AWARE ATTENTION MASK
======================================================================

======================================================================
GROUP: A_uniform
======================================================================

  Running: A_uniform_512...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: uniform(w=508):32
  Layer 1: uniform(w=508):32
  Layer 2: uniform(w=508):32
  Layer 3: uniform(w=508):32
  Layer 4: uniform(w=508):32
  ... (showing first 5 of 32 layers)

PPL: 8.98, Acc: 52.93%: 100%|████████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:53<00:00, 11.53it/s]
    PPL: 8.98, Acc: 52.93%, Eff.Ctx: 512.0

  Running: A_uniform_256...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: uniform(w=252):32
  Layer 1: uniform(w=252):32
  Layer 2: uniform(w=252):32
  Layer 3: uniform(w=252):32
  Layer 4: uniform(w=252):32
  ... (showing first 5 of 32 layers)

PPL: 9.48, Acc: 51.83%: 100%|████████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:52<00:00, 11.57it/s]
    PPL: 9.48, Acc: 51.83%, Eff.Ctx: 256.0

  Running: A_uniform_128...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: uniform(w=124):32
  Layer 1: uniform(w=124):32
  Layer 2: uniform(w=124):32
  Layer 3: uniform(w=124):32
  Layer 4: uniform(w=124):32
  ... (showing first 5 of 32 layers)

PPL: 9.89, Acc: 51.98%: 100%|████████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:53<00:00, 11.55it/s]
    PPL: 9.89, Acc: 51.98%, Eff.Ctx: 128.0

  Running: A_uniform_64...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: uniform(w=60):32
  Layer 1: uniform(w=60):32
  Layer 2: uniform(w=60):32
  Layer 3: uniform(w=60):32
  Layer 4: uniform(w=60):32
  ... (showing first 5 of 32 layers)

PPL: 10.97, Acc: 50.28%: 100%|███████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:52<00:00, 11.57it/s]
    PPL: 10.97, Acc: 50.28%, Eff.Ctx: 64.0

  Running: A_uniform_32...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: uniform(w=28):32
  Layer 1: uniform(w=28):32
  Layer 2: uniform(w=28):32
  Layer 3: uniform(w=28):32
  Layer 4: uniform(w=28):32
  ... (showing first 5 of 32 layers)

PPL: 13.11, Acc: 48.12%: 100%|███████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:53<00:00, 11.55it/s]
    PPL: 13.11, Acc: 48.12%, Eff.Ctx: 32.0

  Running: A_uniform_16...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: uniform(w=12):32
  Layer 1: uniform(w=12):32
  Layer 2: uniform(w=12):32
  Layer 3: uniform(w=12):32
  Layer 4: uniform(w=12):32
  ... (showing first 5 of 32 layers)

PPL: 23.05, Acc: 40.32%: 100%|███████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:53<00:00, 11.50it/s]
    PPL: 23.05, Acc: 40.32%, Eff.Ctx: 16.0

======================================================================
GROUP: B_sink_only
======================================================================

  Running: B_sink_only_512...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: uniform(w=0):32
  Layer 1: uniform(w=0):32
  Layer 2: uniform(w=0):32
  Layer 3: uniform(w=0):32
  Layer 4: uniform(w=0):32
  ... (showing first 5 of 32 layers)

PPL: 123.80, Acc: 26.06%: 100%|██████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:53<00:00, 11.55it/s]
    PPL: 123.80, Acc: 26.06%, Eff.Ctx: 512.0

  Running: B_sink_only_256...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: uniform(w=0):32
  Layer 1: uniform(w=0):32
  Layer 2: uniform(w=0):32
  Layer 3: uniform(w=0):32
  Layer 4: uniform(w=0):32
  ... (showing first 5 of 32 layers)

PPL: 207.51, Acc: 20.46%: 100%|██████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:53<00:00, 11.54it/s]
    PPL: 207.51, Acc: 20.46%, Eff.Ctx: 256.0

  Running: B_sink_only_128...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: uniform(w=0):32
  Layer 1: uniform(w=0):32
  Layer 2: uniform(w=0):32
  Layer 3: uniform(w=0):32
  Layer 4: uniform(w=0):32
  ... (showing first 5 of 32 layers)

PPL: 407.12, Acc: 17.96%: 100%|██████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:53<00:00, 11.53it/s]
    PPL: 407.12, Acc: 17.96%, Eff.Ctx: 128.0

  Running: B_sink_only_64...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: uniform(w=0):32
  Layer 1: uniform(w=0):32
  Layer 2: uniform(w=0):32
  Layer 3: uniform(w=0):32
  Layer 4: uniform(w=0):32
  ... (showing first 5 of 32 layers)

PPL: 507.25, Acc: 15.71%: 100%|██████████████████████████████████████████████████████████████████████████████| 1999/1999 [04:16<00:00,  7.80it/s]
    PPL: 507.25, Acc: 15.71%, Eff.Ctx: 64.0

  Running: B_sink_only_32...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: uniform(w=0):32
  Layer 1: uniform(w=0):32
  Layer 2: uniform(w=0):32
  Layer 3: uniform(w=0):32
  Layer 4: uniform(w=0):32
  ... (showing first 5 of 32 layers)

PPL: 659.46, Acc: 13.46%: 100%|██████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:52<00:00, 11.57it/s]
    PPL: 659.46, Acc: 13.46%, Eff.Ctx: 32.0

  Running: B_sink_only_16...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: uniform(w=0):32
  Layer 1: uniform(w=0):32
  Layer 2: uniform(w=0):32
  Layer 3: uniform(w=0):32
  Layer 4: uniform(w=0):32
  ... (showing first 5 of 32 layers)

PPL: 829.85, Acc: 13.11%: 100%|██████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:52<00:00, 11.57it/s]
    PPL: 829.85, Acc: 13.11%, Eff.Ctx: 16.0

======================================================================
GROUP: C_head_aware_pos
======================================================================

  Running: C_ha_pos4...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: gathering(w=-1):29, mixed(w=64):3
  Layer 1: gathering(w=-1):13, mixed(w=64):16, positional(w=4):3
  Layer 2: gathering(w=-1):24, mixed(w=64):8
  Layer 3: gathering(w=-1):2, mixed(w=64):17, positional(w=4):13
  Layer 4: gathering(w=-1):4, mixed(w=64):25, positional(w=4):3
  ... (showing first 5 of 32 layers)

PPL: 13.03, Acc: 46.92%: 100%|███████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:54<00:00, 11.45it/s]
    PPL: 13.03, Acc: 46.92%, Eff.Ctx: 128.5

  Running: C_ha_pos8...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: gathering(w=-1):29, mixed(w=64):3
  Layer 1: gathering(w=-1):13, mixed(w=64):16, positional(w=8):3
  Layer 2: gathering(w=-1):24, mixed(w=64):8
  Layer 3: gathering(w=-1):2, mixed(w=64):17, positional(w=8):13
  Layer 4: gathering(w=-1):4, mixed(w=64):25, positional(w=8):3
  ... (showing first 5 of 32 layers)

PPL: 12.05, Acc: 49.47%: 100%|███████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:45<00:00, 12.10it/s]
    PPL: 12.05, Acc: 49.47%, Eff.Ctx: 129.9

  Running: C_ha_pos16...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: gathering(w=-1):29, mixed(w=64):3
  Layer 1: gathering(w=-1):13, mixed(w=64):16, positional(w=16):3
  Layer 2: gathering(w=-1):24, mixed(w=64):8
  Layer 3: gathering(w=-1):2, mixed(w=64):17, positional(w=16):13
  Layer 4: gathering(w=-1):4, mixed(w=64):25, positional(w=16):3
  ... (showing first 5 of 32 layers)

PPL: 11.38, Acc: 50.38%: 100%|███████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:44<00:00, 12.15it/s]
    PPL: 11.38, Acc: 50.38%, Eff.Ctx: 132.8

  Running: C_ha_pos32...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: gathering(w=-1):29, mixed(w=64):3
  Layer 1: gathering(w=-1):13, mixed(w=64):16, positional(w=32):3
  Layer 2: gathering(w=-1):24, mixed(w=64):8
  Layer 3: gathering(w=-1):2, mixed(w=64):17, positional(w=32):13
  Layer 4: gathering(w=-1):4, mixed(w=64):25, positional(w=32):3
  ... (showing first 5 of 32 layers)

PPL: 10.83, Acc: 51.38%: 100%|███████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:44<00:00, 12.15it/s]
    PPL: 10.83, Acc: 51.38%, Eff.Ctx: 138.6

  Running: C_ha_pos64...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: gathering(w=-1):29, mixed(w=64):3
  Layer 1: gathering(w=-1):13, mixed(w=64):16, positional(w=64):3
  Layer 2: gathering(w=-1):24, mixed(w=64):8
  Layer 3: gathering(w=-1):2, mixed(w=64):17, positional(w=64):13
  Layer 4: gathering(w=-1):4, mixed(w=64):25, positional(w=64):3
  ... (showing first 5 of 32 layers)

PPL: 10.67, Acc: 50.48%: 100%|███████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:44<00:00, 12.14it/s]
    PPL: 10.67, Acc: 50.48%, Eff.Ctx: 150.2

======================================================================
GROUP: D_head_aware_mix
======================================================================

  Running: D_ha_mix32...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: gathering(w=-1):29, mixed(w=32):3
  Layer 1: gathering(w=-1):13, mixed(w=32):16, positional(w=8):3
  Layer 2: gathering(w=-1):24, mixed(w=32):8
  Layer 3: gathering(w=-1):2, mixed(w=32):17, positional(w=8):13
  Layer 4: gathering(w=-1):4, mixed(w=32):25, positional(w=8):3
  ... (showing first 5 of 32 layers)

PPL: 13.50, Acc: 47.22%: 100%|███████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:44<00:00, 12.12it/s]
    PPL: 13.50, Acc: 47.22%, Eff.Ctx: 112.2

  Running: D_ha_mix64...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: gathering(w=-1):29, mixed(w=64):3
  Layer 1: gathering(w=-1):13, mixed(w=64):16, positional(w=8):3
  Layer 2: gathering(w=-1):24, mixed(w=64):8
  Layer 3: gathering(w=-1):2, mixed(w=64):17, positional(w=8):13
  Layer 4: gathering(w=-1):4, mixed(w=64):25, positional(w=8):3
  ... (showing first 5 of 32 layers)

PPL: 12.05, Acc: 49.47%: 100%|███████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:45<00:00, 12.08it/s]
    PPL: 12.05, Acc: 49.47%, Eff.Ctx: 129.9

  Running: D_ha_mix128...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: gathering(w=-1):29, mixed(w=128):3
  Layer 1: gathering(w=-1):13, mixed(w=128):16, positional(w=8):3
  Layer 2: gathering(w=-1):24, mixed(w=128):8
  Layer 3: gathering(w=-1):2, mixed(w=128):17, positional(w=8):13
  Layer 4: gathering(w=-1):4, mixed(w=128):25, positional(w=8):3
  ... (showing first 5 of 32 layers)

PPL: 11.41, Acc: 49.57%: 100%|███████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:45<00:00, 12.11it/s]
    PPL: 11.41, Acc: 49.57%, Eff.Ctx: 165.3

  Running: D_ha_mix256...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: gathering(w=-1):29, mixed(w=256):3
  Layer 1: gathering(w=-1):13, mixed(w=256):16, positional(w=8):3
  Layer 2: gathering(w=-1):24, mixed(w=256):8
  Layer 3: gathering(w=-1):2, mixed(w=256):17, positional(w=8):13
  Layer 4: gathering(w=-1):4, mixed(w=256):25, positional(w=8):3
  ... (showing first 5 of 32 layers)

PPL: 11.08, Acc: 49.22%: 100%|███████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:44<00:00, 12.16it/s]
    PPL: 11.08, Acc: 49.22%, Eff.Ctx: 236.0

======================================================================
GROUP: E_head_aware_no_sink
======================================================================

  Running: E_ha_no_sink...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: gathering(w=-1):29, mixed(w=68):3
  Layer 1: gathering(w=-1):13, mixed(w=68):16, positional(w=12):3
  Layer 2: gathering(w=-1):24, mixed(w=68):8
  Layer 3: gathering(w=-1):2, mixed(w=68):17, positional(w=12):13
  Layer 4: gathering(w=-1):4, mixed(w=68):25, positional(w=12):3
  ... (showing first 5 of 32 layers)

PPL: 139.84, Acc: 25.46%: 100%|██████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:44<00:00, 12.15it/s]
    PPL: 139.84, Acc: 25.46%, Eff.Ctx: 129.9

======================================================================
GROUP: F_head_aware_default
======================================================================

  Running: F_ha_default...
Evaluating (head-aware mask):   0%|                                                                                     | 0/1999 [00:00<?, ?it/s][PerLayerMaskInjector] Registered 32 hooks

[Per-Layer Mask Config] Head type distribution per layer:
  Layer 0: gathering(w=-1):29, mixed(w=64):3
  Layer 1: gathering(w=-1):13, mixed(w=64):16, positional(w=8):3
  Layer 2: gathering(w=-1):24, mixed(w=64):8
  Layer 3: gathering(w=-1):2, mixed(w=64):17, positional(w=16):1, positional(w=8):12
  Layer 4: gathering(w=-1):4, mixed(w=64):25, positional(w=8):3
  ... (showing first 5 of 32 layers)

PPL: 11.69, Acc: 49.77%: 100%|███████████████████████████████████████████████████████████████████████████████| 1999/1999 [02:44<00:00, 12.15it/s]
    PPL: 11.69, Acc: 49.77%, Eff.Ctx: 130.0

======================================================================
ABLATION RESULTS SUMMARY (by group)
======================================================================

--- A_uniform ---
Name                      PPL      Acc    Eff.Ctx
--------------------------------------------------
A_uniform_512            8.98  52.93%      512.0
A_uniform_256            9.48  51.83%      256.0
A_uniform_128            9.89  51.98%      128.0
A_uniform_64            10.97  50.28%       64.0
A_uniform_32            13.11  48.12%       32.0
A_uniform_16            23.05  40.32%       16.0

--- B_sink_only ---
Name                      PPL      Acc    Eff.Ctx
--------------------------------------------------
B_sink_only_512        123.80  26.06%      512.0
B_sink_only_256        207.51  20.46%      256.0
B_sink_only_128        407.12  17.96%      128.0
B_sink_only_64         507.25  15.71%       64.0
B_sink_only_32         659.46  13.46%       32.0
B_sink_only_16         829.85  13.11%       16.0

--- C_head_aware_pos ---
Name                      PPL      Acc    Eff.Ctx
--------------------------------------------------
C_ha_pos4               13.03  46.92%      128.5
C_ha_pos8               12.05  49.47%      129.9
C_ha_pos16              11.38  50.38%      132.8
C_ha_pos32              10.83  51.38%      138.6  * 
C_ha_pos64              10.67  50.48%      150.2

--- D_head_aware_mix ---
Name                      PPL      Acc    Eff.Ctx
--------------------------------------------------
D_ha_mix32              13.50  47.22%      112.2
D_ha_mix64              12.05  49.47%      129.9
D_ha_mix128             11.41  49.57%      165.3
D_ha_mix256             11.08  49.22%      236.0

--- E_head_aware_no_sink ---
Name                      PPL      Acc    Eff.Ctx
--------------------------------------------------
E_ha_no_sink           139.84  25.46%      129.9

--- F_head_aware_default ---
Name                      PPL      Acc    Eff.Ctx
--------------------------------------------------
F_ha_default            11.69  49.77%      130.0

======================================================================
KEY COMPARISONS
======================================================================

1. Head-Aware vs Uniform (similar effective context):
   Head-Aware Default: PPL=11.69, Ctx=130
   Closest Uniform:    PPL=9.89, Ctx=128
   PPL difference: +18.24% (uniform better)

2. Head-Aware (pos=4) vs Sink-Only 128:
   Head-Aware pos4: PPL=13.03, Ctx=128
   Sink-Only 128:   PPL=407.12, Ctx=128
   PPL difference: -96.80%

3. Effect of Sink Tokens (Head-Aware with vs without sink):
   With sink (4):    PPL=11.69
   Without sink:     PPL=139.84
   PPL degradation without sink: +1096.06%

4. Positional Window Sensitivity:
   C_ha_pos4: PPL=13.03, Ctx=128
   C_ha_pos8: PPL=12.05, Ctx=130
   C_ha_pos16: PPL=11.38, Ctx=133
   C_ha_pos32: PPL=10.83, Ctx=139
   C_ha_pos64: PPL=10.67, Ctx=150

Results saved to: results/ablation_head_aware_mask.json