`torch_dtype` is deprecated! Use `dtype` instead!
Loading models...
Loading dataset from /mnt/disk1/ljm/LLM-Efficient-Reasoning/data/pg19.parquet...

######################################################################
# Comprehensive Speculative Decoding Benchmark
# Dataset: /mnt/disk1/ljm/LLM-Efficient-Reasoning/data/pg19.parquet
# Target Model: /mnt/disk1/models/pythia-2.8b
# Draft Model: /mnt/disk1/models/pythia-70m
# Max New Tokens: 500
# Samples: 3
######################################################################

============================================================
Benchmarking: Baseline (Autoregressive)
============================================================
  Sample 1: 132.4 t/s, TTFT=23.9ms, TPOT=7.50ms
  Sample 2: 133.9 t/s, TTFT=9.4ms, TPOT=7.45ms
  Sample 3: 134.3 t/s, TTFT=9.2ms, TPOT=7.43ms

Baseline Results:
  Throughput: 133.5 t/s
  TTFT: 14.2 ms
  TPOT: 7.46 ms
  Total FLOPs: 4.97e+12

============================================================
Benchmarking: Tree V2 (D=8, B=3, t=0.03)
============================================================
  Sample 1: 207.0 t/s, accept=31.93%, path_len=8.2
  Sample 2: 129.7 t/s, accept=21.48%, path_len=4.1
  Sample 3: 142.0 t/s, accept=21.49%, path_len=5.1

Tree V2 Results:
  Throughput: 159.6 t/s
  Acceptance Rate: 24.96%
  Avg Path Length: 5.8
  Speedup: 1.19x

============================================================
Benchmarking: HuggingFace Assisted Generation
============================================================
  Sample 1: 213.5 t/s, tokens=500
  Sample 2: 254.7 t/s, tokens=500
  Sample 3: 225.9 t/s, tokens=500

HF Assisted Results:
  Throughput: 231.4 t/s
  Speedup: 1.73x

============================================================
Benchmarking: Linear Speculative Decoding (K=5)
============================================================
  Sample 1: 170.7 t/s, accept=101.01%
  Sample 2: 164.0 t/s, accept=90.09%
  Sample 3: 160.5 t/s, accept=87.72%

Linear K=5 Results:
  Throughput: 165.1 t/s
  Acceptance Rate: 92.94%
  Tokens/Round: 4.6
  Speedup: 1.24x

============================================================
Benchmarking: Linear Speculative Decoding (K=6)
============================================================
  Sample 1: 173.0 t/s, accept=85.91%
  Sample 2: 167.6 t/s, accept=81.70%
  Sample 3: 161.7 t/s, accept=78.62%

Linear K=6 Results:
  Throughput: 167.4 t/s
  Acceptance Rate: 82.08%
  Tokens/Round: 4.9
  Speedup: 1.25x

============================================================
Benchmarking: Linear Speculative Decoding (K=7)
============================================================
  Sample 1: 183.7 t/s, accept=82.10%
  Sample 2: 176.5 t/s, accept=77.64%
  Sample 3: 166.8 t/s, accept=73.64%

Linear K=7 Results:
  Throughput: 175.7 t/s
  Acceptance Rate: 77.79%
  Tokens/Round: 5.4
  Speedup: 1.32x

============================================================
Benchmarking: Linear Speculative Decoding (K=8)
============================================================
  Sample 1: 195.3 t/s, accept=81.17%
  Sample 2: 179.1 t/s, accept=72.67%
  Sample 3: 171.6 t/s, accept=70.22%

Linear K=8 Results:
  Throughput: 182.0 t/s
  Acceptance Rate: 74.69%
  Tokens/Round: 6.0
  Speedup: 1.36x

============================================================
Benchmarking: Streaming Speculative Decoding (K=6, cache=1024)
============================================================
  Sample 1: 175.4 t/s
  Sample 2: 169.0 t/s
  Sample 3: 162.8 t/s

Streaming K=6 cache=1024 Results:
  Throughput: 169.0 t/s
  Speedup: 1.27x

============================================================
Benchmarking: Streaming Speculative Decoding (K=6, cache=512)
============================================================
  Sample 1: 175.8 t/s
  Sample 2: 169.0 t/s
  Sample 3: 162.8 t/s

Streaming K=6 cache=512 Results:
  Throughput: 169.2 t/s
  Speedup: 1.27x

============================================================
Acceptance Rate Comparison: Tree vs Linear
============================================================

Linear Methods:
  Linear K=5: acceptance=92.94%, tokens/round=4.6
  Linear K=6: acceptance=82.08%, tokens/round=4.9
  Linear K=7: acceptance=77.79%, tokens/round=5.4
  Linear K=8: acceptance=74.69%, tokens/round=6.0

Tree Methods:
  Tree V2 (D=8, B=3, t=0.03): acceptance=24.96%, path_len=5.8

Summary:
  Avg Linear Acceptance: 81.87%
  Avg Linear Tokens/Round: 5.2
  Avg Tree Acceptance: 24.96%
  Avg Tree Path Length: 5.8

================================================================================
FINAL RESULTS SUMMARY
================================================================================

Rank  Method                              Throughput   Speedup    TTFT(ms)   Accept%   
--------------------------------------------------------------------------------
1     HF Assisted                            231.4 t/s    1.73x    108.6        N/A
2     Linear K=8                             182.0 t/s    1.36x      0.0      74.7%
3     Linear K=7                             175.7 t/s    1.32x      0.0      77.8%
4     Streaming K=6 cache=512                169.2 t/s    1.27x      0.0      82.1%
5     Streaming K=6 cache=1024               169.0 t/s    1.27x      0.0      82.1%
6     Linear K=6                             167.4 t/s    1.25x      0.0      82.1%
7     Linear K=5                             165.1 t/s    1.24x      0.0      92.9%
8     Tree V2 (D=8, B=3, t=0.03)             159.6 t/s    1.19x      0.0      25.0%
9     Baseline (AR)                          133.5 t/s    1.00x     14.2        N/A

================================================================================
FLOPs COMPARISON
================================================================================

Method                              Total FLOPs     FLOPs/Token     Memory(MB)  
--------------------------------------------------------------------------------
Linear K=8                              5.87e+12     6.66e+09       5790
Linear K=7                              5.73e+12     6.39e+09       5790
Linear K=6                              5.54e+12     6.01e+09       5789
Linear K=5                              5.21e+12     5.35e+09       5789
Tree V2 (D=8, B=3, t=0.03)              6.03e+15     1.20e+13       5845
Baseline (AR)                           4.97e+12     4.87e+09       5813

============================================================
Acceptance Rate Comparison: Tree vs Linear
============================================================

Linear Methods:
  Linear K=5: acceptance=92.94%, tokens/round=4.6
  Linear K=6: acceptance=82.08%, tokens/round=4.9
  Linear K=7: acceptance=77.79%, tokens/round=5.4
  Linear K=8: acceptance=74.69%, tokens/round=6.0

Tree Methods:
  Tree V2 (D=8, B=3, t=0.03): acceptance=24.96%, path_len=5.8

Summary:
  Avg Linear Acceptance: 81.87%
  Avg Linear Tokens/Round: 5.2
  Avg Tree Acceptance: 24.96%
  Avg Tree Path Length: 5.8

================================================================================
FINAL RESULTS SUMMARY
================================================================================

Rank  Method                              Throughput   Speedup    TTFT(ms)   Accept%   
--------------------------------------------------------------------------------
1     HF Assisted                            231.4 t/s    1.73x    108.6        N/A
2     Linear K=8                             182.0 t/s    1.36x      0.0      74.7%
3     Linear K=7                             175.7 t/s    1.32x      0.0      77.8%
4     Streaming K=6 cache=512                169.2 t/s    1.27x      0.0      82.1%
5     Streaming K=6 cache=1024               169.0 t/s    1.27x      0.0      82.1%
6     Linear K=6                             167.4 t/s    1.25x      0.0      82.1%
7     Linear K=5                             165.1 t/s    1.24x      0.0      92.9%
8     Tree V2 (D=8, B=3, t=0.03)             159.6 t/s    1.19x      0.0      25.0%
9     Baseline (AR)                          133.5 t/s    1.00x     14.2        N/A

================================================================================
FLOPs COMPARISON
================================================================================

Method                              Total FLOPs     FLOPs/Token     Memory(MB)  
--------------------------------------------------------------------------------
Linear K=8                              5.87e+12     6.66e+09       5790
Linear K=7                              5.73e+12     6.39e+09       5790
Linear K=6                              5.54e+12     6.01e+09       5789
Linear K=5                              5.21e+12     5.35e+09       5789
Tree V2 (D=8, B=3, t=0.03)              6.03e+15     1.20e+13       5845
Baseline (AR)                           4.97e+12     4.87e+09       5813

Results saved to: results/comprehensive_benchmark_20260103_141753.json
