# 自适应树结构消融实验分析

## 实验设置

### 基础配置

| 参数 | 值 |
|------|-----|
| 目标模型 | Pythia-2.8B |
| 草稿模型 | Pythia-70m |
| 数据集 | WikiText-2 (ModelScope) |
| 样本数 | 10 |
| 热身轮数 | 2 |
| 最大提示长度 | 800 tokens |
| 生成 token 数 | 500 |

### Adaptive 方法参数配置

| 参数 | 值 | 说明 |
|------|-----|------|
| `high_conf_threshold` | **0.8** | 高置信度阈值 |
| `low_conf_threshold` | **0.3** | 低置信度阈值 |
| `min_branch` | **1** | 最小分支因子 |
| `max_branch` | **4** | 最大分支因子 |

> ⚠️ **注**: 敏感性实验表明最优配置为 `0.9/0.4/1/3`，可提升约 6% 性能。本实验使用的是默认配置。

---

## 一、主要结果概览

### 1.1 Baseline 基准

| 方法 | 吞吐量 (t/s) | Speedup | TTFT (ms) | TPOT (ms) |
|------|-------------|---------|-----------|-----------|
| Baseline (AR) | 132.7±0.9 | 1.00x | 19.1±6.2 | 7.50±0.05 |

---

## 二、分组消融实验

### 2.1 Base Depth = 4 对比组

**对照组**: Fixed Tree (D=4, B=2)

| 方法 | 吞吐量 (t/s) | vs Baseline | vs Fixed | Accept% | PathLen | Rounds | Tokens/Round |
|------|-------------|-------------|----------|---------|---------|--------|--------------|
| **Fixed Tree D=4** | 145.1±37.9 | **1.09x** | 1.00x | 77.7% | 4.66 | 108 | 4.63 |
| Phase 1: Adaptive Branch | 167.4±20.7 | **1.26x** | 1.15x | 77.1% | 4.62 | 109 | 4.59 |
| Phase 2: + Dynamic Depth | 185.3±34.8 | **1.40x** | 1.28x | 87.0% | 5.22 | 102 | 4.90 |
| Phase 3: + History Adjust | 189.4±34.4 | **1.43x** | 1.31x | 92.3% | 5.54 | 95 | 5.26 |

**分析**:
- Phase 1 → Phase 2: 吞吐量 +10.7%, 接受率 +9.9pp, 路径长度 +0.60
- Phase 2 → Phase 3: 吞吐量 +2.2%, 接受率 +5.3pp, 路径长度 +0.32
- **总提升**: 相比 Fixed Tree D=4, Phase 3 提升 **31%** 吞吐量

---

### 2.2 Base Depth = 5 对比组

**对照组**: Fixed Tree (D=5, B=2)

| 方法 | 吞吐量 (t/s) | vs Baseline | vs Fixed | Accept% | PathLen | Rounds | Tokens/Round |
|------|-------------|-------------|----------|---------|---------|--------|--------------|
| **Fixed Tree D=5** | 177.0±21.4 | **1.33x** | 1.00x | 73.8% | 5.17 | 98 | 5.10 |
| Phase 1: Adaptive Branch | 174.0±26.0 | **1.31x** | 0.98x | 72.9% | 5.10 | 100 | 5.00 |
| Phase 2: + Dynamic Depth | 183.5±34.2 | **1.38x** | 1.04x | 75.9% | 5.31 | 99 | 5.05 |
| Phase 3: + History Adjust | 187.2±35.1 | **1.41x** | 1.06x | 80.3% | 5.62 | 94 | 5.32 |

**分析**:
- Phase 1 略低于 Fixed Tree（因为自适应分支开销）
- Phase 2 通过动态深度弥补，超过 Fixed Tree 4%
- Phase 3 进一步提升，达到 **6%** 吞吐量提升

---

### 2.3 Base Depth = 6 对比组

**对照组**: Fixed Tree (D=6, B=2)

| 方法 | 吞吐量 (t/s) | vs Baseline | vs Fixed | Accept% | PathLen | Rounds | Tokens/Round |
|------|-------------|-------------|----------|---------|---------|--------|--------------|
| **Fixed Tree D=6** | 183.3±25.0 | **1.38x** | 1.00x | 69.5% | 5.56 | 91 | 5.49 |
| Phase 1: Adaptive Branch | 176.9±28.3 | **1.33x** | 0.97x | 68.9% | 5.51 | 92 | 5.43 |
| Phase 2: + Dynamic Depth | 191.3±36.8 | **1.44x** | 1.04x | 72.2% | 5.78 | 92 | 5.43 |
| Phase 3: + History Adjust | 192.3±36.1 | **1.45x** | 1.05x | 74.2% | 5.94 | 89 | 5.62 |

**分析**:
- Phase 2 是性能跃升的关键（+8.1% vs Phase 1）
- Phase 3 达到最高吞吐量 **192.3 t/s**
- 相比 Fixed Tree D=6, 提升 **5%** 吞吐量

---

### 2.4 Fixed Tree 不同深度对比

| 深度 | 吞吐量 (t/s) | vs Baseline | Accept% | PathLen | 分析 |
|------|-------------|-------------|---------|---------|------|
| D=4 | 145.1 | 1.09x | 77.7% | 4.66 | 接受率最高，但路径短 |
| D=5 | 177.0 | 1.33x | 73.8% | 5.17 | 平衡点 |
| D=6 | 183.3 | **1.38x** | 69.5% | 5.56 | 吞吐量最高 |
| D=7 | 182.7 | 1.38x | 64.5% | 5.81 | 接受率下降，收益递减 |

**结论**: Fixed Tree 在 D=6 达到最佳吞吐量，继续增加深度收益递减。

---

## 三、各 Phase 贡献分析

### 3.1 Phase 贡献汇总表

| Base Depth | Phase 1 提升 | Phase 2 提升 | Phase 3 提升 | 总提升 (vs Fixed) |
|------------|-------------|-------------|-------------|------------------|
| D=4 | +15.4% | +10.7% | +2.2% | **+31%** |
| D=5 | -1.7% | +5.5% | +2.0% | **+6%** |
| D=6 | -3.5% | +8.1% | +0.5% | **+5%** |

### 3.2 各 Phase 作用机制

| Phase | 机制 | 关键指标 | 效果 |
|-------|------|---------|------|
| **Phase 1: Adaptive Branch** | 高置信度少分支，低置信度多分支 | high_conf_ratio=65-69% | 减少冗余计算 |
| **Phase 2: Dynamic Depth** | 早停 + 深度扩展 | early_stops=217-249, deep_expansions=61-131 | 大幅提升接受率 |
| **Phase 3: History Adjust** | 根据历史接受率调整参数 | total_adjustments=8 | 稳定性提升 |

---

## 四、置信度分布分析

### 4.1 各配置置信度比例

| 配置 | 高置信度 | 中置信度 | 低置信度 |
|------|---------|---------|---------|
| Phase 1 (D=4) | 65.6% | 21.3% | 13.1% |
| Phase 2 (D=4) | 69.0% | 20.3% | 10.7% |
| Phase 3 (D=4) | **77.4%** | 12.3% | 10.3% |
| Phase 1 (D=5) | 66.9% | 20.5% | 12.6% |
| Phase 2 (D=5) | 67.8% | 21.3% | 10.9% |
| Phase 3 (D=5) | **75.1%** | 14.0% | 10.9% |
| Phase 1 (D=6) | 65.3% | 21.7% | 12.9% |
| Phase 2 (D=6) | 69.8% | 19.3% | 10.9% |
| Phase 3 (D=6) | **73.1%** | 16.1% | 10.7% |

**观察**: Phase 3 的历史调整使高置信度比例显著增加（+8-12pp），表明参数调整有效。

---

## 五、关键结论

### 5.1 最佳配置

| 指标 | 最佳配置 | 值 |
|------|---------|-----|
| **最高吞吐量** | Phase 3 (D=6) | **192.3 t/s** |
| **最高接受率** | Phase 3 (D=4) | **92.3%** |
| **最长路径** | Phase 3 (D=6) | **5.94** |
| **最大加速比** | Phase 3 (D=6) | **1.45x** |

### 5.2 核心发现

1. **Phase 2 (动态深度) 贡献最大**
   - 在所有 base_depth 配置下，Phase 2 都带来显著提升
   - 早停机制减少无效扩展，深度扩展增加高置信路径

2. **自适应方法在浅层树优势更大**
   - D=4: +31% vs Fixed Tree
   - D=6: +5% vs Fixed Tree
   - 因为浅层树的固定结构限制更明显

3. **Phase 3 持续但边际递减**
   - 主要提升接受率和稳定性
   - 历史调整需要更多轮次才能充分发挥作用

4. **最佳实践建议**
   - 资源有限时：使用 Phase 3 + D=4（高接受率，低延迟）
   - 追求吞吐量：使用 Phase 3 + D=6（最高 192.3 t/s）

---

## 六、Speedup 计算说明

> **注**: 原始输出中 Speedup 均为 1.00，这是代码 bug。正确的 Speedup 应该是相对于 Baseline 的加速比。

**正确计算**:

| 方法 | 吞吐量 (t/s) | Speedup = 吞吐量 / 132.65 |
|------|-------------|---------------------------|
| Baseline | 132.65 | 1.00x |
| Fixed D=4 | 145.13 | 1.09x |
| Fixed D=5 | 176.97 | 1.33x |
| Fixed D=6 | 183.29 | 1.38x |
| Fixed D=7 | 182.68 | 1.38x |
| Phase 3 (D=4) | 189.44 | **1.43x** |
| Phase 3 (D=5) | 187.24 | **1.41x** |
| Phase 3 (D=6) | 192.25 | **1.45x** |

---

*生成时间: 2026-01-05*

