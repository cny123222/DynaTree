`torch_dtype` is deprecated! Use `dtype` instead!
Loading models...
Loading dataset from /mnt/disk1/ljm/LLM-Efficient-Reasoning/data/pg19.parquet...
Using standard short prompt (reproducible mode)

######################################################################
# Comprehensive Speculative Decoding Benchmark
# Dataset: /mnt/disk1/ljm/LLM-Efficient-Reasoning/data/pg19.parquet
# Target Model: /mnt/disk1/models/pythia-2.8b
# Draft Model: /mnt/disk1/models/pythia-70m
# Max New Tokens: 500
# Samples: 5
######################################################################

============================================================
Benchmarking: Baseline (Autoregressive)
============================================================
  Sample 1: 100.3 t/s, TTFT=18.2ms, TPOT=9.93ms
  Sample 2: 133.8 t/s, TTFT=9.1ms, TPOT=7.45ms
  Sample 3: 134.5 t/s, TTFT=9.7ms, TPOT=7.42ms
  Sample 4: 134.9 t/s, TTFT=9.1ms, TPOT=7.39ms
  Sample 5: 135.4 t/s, TTFT=9.3ms, TPOT=7.36ms

Baseline Results:
  Throughput: 127.8 t/s
  TTFT: 11.1 ms
  TPOT: 7.91 ms
  Total FLOPs: 4.97e+12

============================================================
Benchmarking: Tree V2 (D=8, B=3, t=0.03)
============================================================
  Sample 1: 178.0 t/s, accept=68.59%, path_len=6.2
  Sample 2: 177.9 t/s, accept=68.59%, path_len=6.2
  Sample 3: 176.2 t/s, accept=68.59%, path_len=6.2
  Sample 4: 177.1 t/s, accept=68.59%, path_len=6.2
  Sample 5: 115.9 t/s, accept=68.59%, path_len=6.2

Tree V2 Results:
  Throughput: 165.0 t/s
  Acceptance Rate: 68.59%
  Avg Path Length: 6.2
  Speedup: 1.29x

============================================================
Benchmarking: HuggingFace Assisted Generation
============================================================
  Sample 1: 87.4 t/s, tokens=500
  Sample 2: 91.7 t/s, tokens=500
  Sample 3: 160.9 t/s, tokens=500
  Sample 4: 161.8 t/s, tokens=500
  Sample 5: 161.5 t/s, tokens=500

HF Assisted Results:
  Throughput: 132.7 t/s
  Speedup: 1.04x

============================================================
Benchmarking: Linear Speculative Decoding (K=5)
============================================================
  Sample 1: 84.0 t/s, accept=72.46%
  Sample 2: 70.3 t/s, accept=72.46%
  Sample 3: 131.5 t/s, accept=72.46%
  Sample 4: 131.4 t/s, accept=72.46%
  Sample 5: 132.1 t/s, accept=72.46%

Linear K=5 Results:
  Throughput: 109.9 t/s
  Acceptance Rate: 72.46%
  Tokens/Round: 3.6
  Speedup: 0.86x

============================================================
Benchmarking: Linear Speculative Decoding (K=6)
============================================================
  Sample 1: 141.1 t/s, accept=68.31%
  Sample 2: 139.9 t/s, accept=68.31%
  Sample 3: 140.5 t/s, accept=68.31%
  Sample 4: 139.8 t/s, accept=68.31%
  Sample 5: 139.8 t/s, accept=68.31%

Linear K=6 Results:
  Throughput: 140.2 t/s
  Acceptance Rate: 68.31%
  Tokens/Round: 4.1
  Speedup: 1.10x

============================================================
Benchmarking: Linear Speculative Decoding (K=7)
============================================================
  Sample 1: 139.0 t/s, accept=61.58%
  Sample 2: 139.6 t/s, accept=61.58%
  Sample 3: 138.9 t/s, accept=61.58%
  Sample 4: 139.5 t/s, accept=61.58%
  Sample 5: 139.6 t/s, accept=61.58%

Linear K=7 Results:
  Throughput: 139.3 t/s
  Acceptance Rate: 61.58%
  Tokens/Round: 4.3
  Speedup: 1.09x

============================================================
Benchmarking: Linear Speculative Decoding (K=8)
============================================================
  Sample 1: 70.2 t/s, accept=55.80%
  Sample 2: 70.7 t/s, accept=55.80%
  Sample 3: 118.5 t/s, accept=55.80%
  Sample 4: 138.0 t/s, accept=55.80%
  Sample 5: 111.3 t/s, accept=55.80%

Linear K=8 Results:
  Throughput: 101.8 t/s
  Acceptance Rate: 55.80%
  Tokens/Round: 4.5
  Speedup: 0.80x

============================================================
Benchmarking: Streaming Speculative Decoding (K=6, cache=1024)
============================================================
  Sample 1: 80.0 t/s
  Sample 2: 141.5 t/s
  Sample 3: 140.4 t/s
  Sample 4: 140.8 t/s
  Sample 5: 140.4 t/s

Streaming K=6 cache=1024 Results:
  Throughput: 128.6 t/s
  Speedup: 1.01x

============================================================
Benchmarking: Streaming Speculative Decoding (K=6, cache=512)
============================================================
  Sample 1: 140.1 t/s
  Sample 2: 140.1 t/s
  Sample 3: 139.3 t/s
  Sample 4: 140.1 t/s
  Sample 5: 140.0 t/s

Streaming K=6 cache=512 Results:
  Throughput: 139.9 t/s
  Speedup: 1.09x

============================================================
Acceptance Rate Comparison: Tree vs Linear
============================================================

Linear Methods:
  Linear K=5: acceptance=72.46%, tokens/round=3.6
  Linear K=6: acceptance=68.31%, tokens/round=4.1
  Linear K=7: acceptance=61.58%, tokens/round=4.3
  Linear K=8: acceptance=55.80%, tokens/round=4.5

Tree Methods:
  Tree V2 (D=8, B=3, t=0.03): acceptance=68.59%, path_len=6.2

Summary:
  Avg Linear Acceptance: 64.54%
  Avg Linear Tokens/Round: 4.1
  Avg Tree Acceptance: 68.59%
  Avg Tree Path Length: 6.2

================================================================================
FINAL RESULTS SUMMARY
================================================================================

Rank  Method                              Throughput   Speedup    TTFT(ms)   Accept%   
--------------------------------------------------------------------------------
1     Tree V2 (D=8, B=3, t=0.03)             165.0 t/s    1.29x      0.0      68.6%
2     Linear K=6                             140.2 t/s    1.10x      0.0      68.3%
3     Streaming K=6 cache=512                139.9 t/s    1.09x      0.0      68.3%
4     Linear K=7                             139.3 t/s    1.09x      0.0      61.6%
5     HF Assisted                            132.7 t/s    1.04x    204.7        N/A
6     Streaming K=6 cache=1024               128.6 t/s    1.01x      0.0      68.3%
7     Baseline (AR)                          127.8 t/s    1.00x     11.1        N/A
8     Linear K=5                             109.9 t/s    0.86x      0.0      72.5%
9     Linear K=8                             101.8 t/s    0.80x      0.0      55.8%

================================================================================
FLOPs COMPARISON
================================================================================

Method                              Total FLOPs     FLOPs/Token     Memory(MB)  
--------------------------------------------------------------------------------
Tree V2 (D=8, B=3, t=0.03)              5.19e+15     1.04e+13       5714
Linear K=6                              6.17e+12     7.26e+09       5709
Linear K=7                              6.56e+12     8.05e+09       5709
Baseline (AR)                           4.97e+12     4.87e+09       5666
Linear K=5                              5.96e+12     6.84e+09       5712
Linear K=8                              6.98e+12     8.89e+09       5711

============================================================
Acceptance Rate Comparison: Tree vs Linear
============================================================

Linear Methods:
  Linear K=5: acceptance=72.46%, tokens/round=3.6
  Linear K=6: acceptance=68.31%, tokens/round=4.1
  Linear K=7: acceptance=61.58%, tokens/round=4.3
  Linear K=8: acceptance=55.80%, tokens/round=4.5

Tree Methods:
  Tree V2 (D=8, B=3, t=0.03): acceptance=68.59%, path_len=6.2

Summary:
  Avg Linear Acceptance: 64.54%
  Avg Linear Tokens/Round: 4.1
  Avg Tree Acceptance: 68.59%
  Avg Tree Path Length: 6.2

================================================================================
FINAL RESULTS SUMMARY
================================================================================

Rank  Method                              Throughput   Speedup    TTFT(ms)   Accept%   
--------------------------------------------------------------------------------
1     Tree V2 (D=8, B=3, t=0.03)             165.0 t/s    1.29x      0.0      68.6%
2     Linear K=6                             140.2 t/s    1.10x      0.0      68.3%
3     Streaming K=6 cache=512                139.9 t/s    1.09x      0.0      68.3%
4     Linear K=7                             139.3 t/s    1.09x      0.0      61.6%
5     HF Assisted                            132.7 t/s    1.04x    204.7        N/A
6     Streaming K=6 cache=1024               128.6 t/s    1.01x      0.0      68.3%
7     Baseline (AR)                          127.8 t/s    1.00x     11.1        N/A
8     Linear K=5                             109.9 t/s    0.86x      0.0      72.5%
9     Linear K=8                             101.8 t/s    0.80x      0.0      55.8%

================================================================================
FLOPs COMPARISON
================================================================================

Method                              Total FLOPs     FLOPs/Token     Memory(MB)  
--------------------------------------------------------------------------------
Tree V2 (D=8, B=3, t=0.03)              5.19e+15     1.04e+13       5714
Linear K=6                              6.17e+12     7.26e+09       5709
Linear K=7                              6.56e+12     8.05e+09       5709
Baseline (AR)                           4.97e+12     4.87e+09       5666
Linear K=5                              5.96e+12     6.84e+09       5712
Linear K=8                              6.98e+12     8.89e+09       5711

Results saved to: results/comprehensive_benchmark_20260103_143607.json
